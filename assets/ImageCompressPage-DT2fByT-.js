import{J as R,S as A,h as L}from"./moment-C4sqyvvr.js";import{_ as P,o as i,c,q as a,D as $,t as _,v as D,d as N,r as w,y as O,F as E,m as U,p as z,s as B,a as Y}from"./index-B5PT-rZe.js";const C=o=>o<1024?o+"B":o<1024*1024?(o/1024).toFixed(2)+"KB":(o/1024/1024).toFixed(2)+"M",F=(o,n)=>{const s=document.createElement("a");s.href=URL.createObjectURL(o),s.download=`${n}`,s.style.display="none",document.body.appendChild(s),s.click(),URL.revokeObjectURL(s.href),document.body.removeChild(s)},T=async o=>{const n=new R;for(let s=0;s<o.length;++s){let l=o[s];if(l.buffer){let r=new Blob([l.buffer],{type:l.file.type});n.file(l.file.name,r,{binary:!0})}}return n.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:9}}).then(s=>s)},V=o=>new Promise((n,s)=>{let l=File.prototype.slice,r=2097152,g=Math.ceil(o.size/r),p=0,m=new A.ArrayBuffer,h=new FileReader;h.onload=function(u){var v;console.log("read chunk nr",p+1,"of",g),m.append((v=u.target)==null?void 0:v.result),p++,p<g?y():n(m.end())},h.onerror=function(){s()};function y(){let u=p*r,v=u+r>=o.size?o.size:u+r;h.readAsArrayBuffer(l.call(o,u,v))}y()}),I={name:"ProgressBar",props:{percent:{type:[Number,String],default:0},text:{type:String,default:""}}},J={class:"progress-bar"},Z={class:"progress-bg"},q={key:0,class:"progress-text d-center"};function K(o,n,s,l,r,g){return i(),c("div",J,[a("div",Z,[a("div",{class:"progress-percent",style:$({width:s.percent+"%"})},null,4)]),s.text?(i(),c("div",q,_(s.text),1)):D("",!0)])}const G=P(I,[["render",K]]),H={class:"page w-full h-full compress-page"},Q=a("p",null,"点击选择或拖动webp、jpeg、png图片到这里",-1),W=a("p",{class:"h-1"},"最多 20 张图片，每张最大 5 MB",-1),X={key:0,class:"file-list"},ee={class:"name text-left"},te={class:"size text-right"},se={class:"size text-left"},ne=["onClick"],oe={key:0,class:"rate"},ae={key:1,class:"rate"},le={key:1,class:"download-all"},de=N({__name:"ImageCompressPage",setup(o){const n=w([]),s=w(),l=O(()=>n.value.filter(e=>e.valid).length>1),r=()=>{s.value.click()},g=e=>{if(e.length>0){const d=["image/png","image/jpeg","image/jpg","image/webp"];for(let t=0;t<e.length&&!(n.value.length>=20);++t){let f=e[t];V(f).then(k=>{let x=n.value.findIndex(M=>M.md5===k);if(x!==-1){n.value[x].repeat=!0,setTimeout(()=>{n.value[x].repeat=!1},500);return}let j=d.indexOf(f.type),b=f.size>5*1024*1024?"File is too large (max 5 MB)":"";b=j===-1?"File type is not supported":b,n.value.push({file:f,valid:!b,progress:0,size:0,error:b,md5:k,repeat:!1}),n.value[n.value.length-1].valid})}}},p=w(!1),m=e=>{const d=e.target.files;g(d)},h=e=>{e.stopPropagation(),e.preventDefault(),p.value=!0},y=e=>{e.stopPropagation(),e.preventDefault(),p.value=!1},u=e=>{e.stopPropagation(),e.preventDefault(),g(e.dataTransfer.files)},v=(e,d)=>{if(!e.buffer){n.value.splice(d,1);return}let t=new Blob([e.buffer],{type:e.file.type});F(t,e.file.name)},S=async()=>{const e=await T(n.value),d="green-"+L(new Date).format("YYYY-MM-DD")+".zip";F(e,d)};return(e,d)=>(i(),c("div",H,[a("div",{class:"select-image d-column d-center",onDrop:u,onDragleave:y,onDragover:h,onClick:r},[Q,W,a("input",{ref_key:"imageRef",ref:s,type:"file",multiple:"true",onChange:m,accept:".png,.jpg,.jpeg,image/png,image/jpg,image/jpeg"},null,544)],32),n.value.length>0?(i(),c("div",X,[a("ul",null,[(i(!0),c(E,null,U(n.value,(t,f)=>(i(),c("li",{class:z(["d-flex",{repeat:t.repeat}]),key:f+"sdx"},[a("div",ee,_(t.file.name),1),a("div",te,_(B(C)(t.file.size)),1),Y(G,{percent:t.progress,class:z({"progress-red":!t.valid}),text:t.error?t.error:t.valid?t.size===0?"Compressing":"Finished":"File type is not supported"},null,8,["percent","class","text"]),a("div",se,_(t.size>0?B(C)(t.size):""),1),a("div",{class:"download",onClick:k=>v(t,f)},_(t.valid?"Download":"Delete"),9,ne),t.valid?(i(),c("div",oe," -"+_(t.size?((1-t.size/t.file.size)*100).toFixed(0):"0.00")+"% ",1)):(i(),c("div",ae))],2))),128))])])):D("",!0),l.value?(i(),c("div",le,[a("div",{class:"btn-all",onClick:S},"Download all")])):D("",!0)]))}});export{de as default};
