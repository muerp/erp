import{J as A,S as L,h as P}from"./moment-BsUqAc_B.js";import{_ as $,o as i,c,q as a,D as N,t as _,v as D,d as O,r as w,y as E,F as U,m as Y,p as B,s as C,a as T}from"./index-CuWS8quN.js";const F=o=>o<1024?o+"B":o<1024*1024?(o/1024).toFixed(2)+"KB":(o/1024/1024).toFixed(2)+"M",S=(o,n)=>{const s=document.createElement("a");s.href=URL.createObjectURL(o),s.download=`${n}`,s.style.display="none",document.body.appendChild(s),s.click(),URL.revokeObjectURL(s.href),document.body.removeChild(s)},V=async o=>{const n=new A;for(let s=0;s<o.length;++s){let l=o[s];if(l.buffer){let r=new Blob([l.buffer],{type:l.file.type});n.file(l.file.name,r,{binary:!0})}}return n.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:9}}).then(s=>s)},I=o=>new Promise((n,s)=>{let l=File.prototype.slice,r=2097152,g=Math.ceil(o.size/r),p=0,m=new L.ArrayBuffer,h=new FileReader;h.onload=function(u){var v;console.log("read chunk nr",p+1,"of",g),m.append((v=u.target)==null?void 0:v.result),p++,p<g?y():n(m.end())},h.onerror=function(){s()};function y(){let u=p*r,v=u+r>=o.size?o.size:u+r;h.readAsArrayBuffer(l.call(o,u,v))}y()}),J={name:"ProgressBar",props:{percent:{type:[Number,String],default:0},text:{type:String,default:""}}},Z={class:"progress-bar"},q={class:"progress-bg"},K={key:0,class:"progress-text d-center"};function G(o,n,s,l,r,g){return i(),c("div",Z,[a("div",q,[a("div",{class:"progress-percent",style:N({width:s.percent+"%"})},null,4)]),s.text?(i(),c("div",K,_(s.text),1)):D("",!0)])}const H=$(J,[["render",G]]),Q={class:"page w-full h-full compress-page"},W=a("p",null,"点击选择或拖动webp、jpeg、png图片到这里",-1),X=a("p",{class:"h-1"},"最多 20 张图片，每张最大 5 MB",-1),ee={key:0,class:"file-list"},te={class:"name text-left"},se={class:"size text-right"},ne={class:"size text-left"},oe=["onClick"],ae={key:0,class:"rate"},le={key:1,class:"rate"},re={key:1,class:"download-all"},de=O({__name:"ImageCompressPage",setup(o){const n=w([]),s=w(),l=E(()=>n.value.filter(e=>e.valid).length>1),r=()=>{s.value.click()},g=e=>{if(e.length>0){const d=["image/png","image/jpeg","image/jpg","image/webp"];for(let t=0;t<e.length&&!(n.value.length>=20);++t){let f=e[t];I(f).then(k=>{let x=n.value.findIndex(R=>R.md5===k);if(x!==-1){n.value[x].repeat=!0,setTimeout(()=>{n.value[x].repeat=!1},500);return}let M=d.indexOf(f.type),b=f.size>5*1024*1024?"File is too large (max 5 MB)":"";b=M===-1?"File type is not supported":b,n.value.push({file:f,valid:!b,progress:0,size:0,error:b,md5:k,repeat:!1});const z=n.value[n.value.length-1];z.valid&&console.log("-------",z)})}}},p=w(!1),m=e=>{const d=e.target.files;g(d)},h=e=>{e.stopPropagation(),e.preventDefault(),p.value=!0},y=e=>{e.stopPropagation(),e.preventDefault(),p.value=!1},u=e=>{e.stopPropagation(),e.preventDefault(),g(e.dataTransfer.files)},v=(e,d)=>{if(!e.buffer){n.value.splice(d,1);return}let t=new Blob([e.buffer],{type:e.file.type});S(t,e.file.name)},j=async()=>{const e=await V(n.value),d="green-"+P(new Date).format("YYYY-MM-DD")+".zip";S(e,d)};return(e,d)=>(i(),c("div",Q,[a("div",{class:"select-image d-column d-center",onDrop:u,onDragleave:y,onDragover:h,onClick:r},[W,X,a("input",{ref_key:"imageRef",ref:s,type:"file",multiple:"true",onChange:m,accept:".png,.jpg,.jpeg,image/png,image/jpg,image/jpeg"},null,544)],32),n.value.length>0?(i(),c("div",ee,[a("ul",null,[(i(!0),c(U,null,Y(n.value,(t,f)=>(i(),c("li",{class:B(["d-flex",{repeat:t.repeat}]),key:f+"sdx"},[a("div",te,_(t.file.name),1),a("div",se,_(C(F)(t.file.size)),1),T(H,{percent:t.progress,class:B({"progress-red":!t.valid}),text:t.error?t.error:t.valid?t.size===0?"Compressing":"Finished":"File type is not supported"},null,8,["percent","class","text"]),a("div",ne,_(t.size>0?C(F)(t.size):""),1),a("div",{class:"download",onClick:k=>v(t,f)},_(t.valid?"Download":"Delete"),9,oe),t.valid?(i(),c("div",ae," -"+_(t.size?((1-t.size/t.file.size)*100).toFixed(0):"0.00")+"% ",1)):(i(),c("div",le))],2))),128))])])):D("",!0),l.value?(i(),c("div",re,[a("div",{class:"btn-all",onClick:j},"Download all")])):D("",!0)]))}});export{de as default};
